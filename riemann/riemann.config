; Importer les bibliothÃ¨ques nÃ©cessaires
(require '[riemann.influxdb :as influxdb])

; Configuration des serveurs d'Ã©coute
(tcp-server {:host "0.0.0.0" :port 5555})
(udp-server {:host "0.0.0.0" :port 5555})
(ws-server  {:host "0.0.0.0" :port 5556})

; Configuration du logging - Plus verbose pour le dÃ©bogage
(logging/init {:file "/var/log/riemann.log"
               :console true
               :level :debug})

; Afficher un message au dÃ©marrage
(info "ğŸš€ Riemann dÃ©marre avec la configuration de dÃ©bogage")

; Configuration de base InfluxDB
(def influxdb-config
  {:host "influxdb" 
   :port 8086 
   :db "riemann"
   :username "riemann"
   :password "riemann"
   :version :v1})  ; SpÃ©cifier la version d'InfluxDB

; CrÃ©er un client InfluxDB pour une utilisation plus stable
(def influx-writer
  (influxdb/influxdb influxdb-config))

; DÃ©finition des streams et rÃ¨gles
(let [index (index)]
  (streams
    ; Indexation des Ã©vÃ©nements
    (fn [event]
      (info "ğŸ” Indexation de l'Ã©vÃ©nement:" event)
      (index event))
    
    ; Log tous les Ã©vÃ©nements reÃ§us avec leurs dÃ©tails
    (fn [event]
      (info "ğŸ“¥ Ã‰vÃ©nement reÃ§u:"
            (select-keys event [:host :service :metric :time :tags]))
      event)
    
    ; Traitement de tous les Ã©vÃ©nements avec une mÃ©trique non-nil
    (where (not (nil? :metric))
      (fn [event]
        (info "ğŸ“Š Envoi vers InfluxDB:" (select-keys event [:host :service :metric]))
        (try
          (influx-writer event)
          (info "âœ… Envoi Ã  InfluxDB rÃ©ussi pour" (:host event) "service:" (:service event))
          (catch Exception e
            (error "âŒ Erreur d'envoi Ã  InfluxDB:" (.getMessage e))))))
    
    ; Traitement spÃ©cifique pour les mÃ©triques CPU
    (where (service "cpu")
      (fn [event]
        (info "ğŸ–¥ï¸ MÃ©trique CPU reÃ§ue:" (select-keys event [:host :metric]))
        
        ; Alertes CPU Ã©levÃ© (>80%)
        (when (and (:metric event) (> (:metric event) 80))
          (warn "âš ï¸ ALERTE: CPU Ã©levÃ© sur" (:host event) "=" (:metric event) "%"))
        
        event))
    
    ; Traitement spÃ©cifique pour les mÃ©triques mÃ©moire
    (where (service "memory")
      (fn [event]
        (info "ğŸ’¾ MÃ©trique mÃ©moire reÃ§ue:" (select-keys event [:host :metric]))
        
        ; Alertes mÃ©moire Ã©levÃ©e (>90%)
        (when (and (:metric event) (> (:metric event) 90))
          (warn "âš ï¸ ALERTE: MÃ©moire Ã©levÃ©e sur" (:host event) "=" (:metric event) "%"))
        
        event))
    
    ; Traitement des Ã©vÃ©nements de latence
    (where (service #".*latency.*")
      (fn [event]
        (info "â±ï¸ MÃ©trique de latence reÃ§ue:" (select-keys event [:host :service :metric]))
        
        ; Alertes latence Ã©levÃ©e (>1.0)
        (when (and (:metric event) (> (:metric event) 1.0))
          (warn "âš ï¸ ALERTE: Latence Ã©levÃ©e sur" (:host event) "service:" (:service event) "=" (:metric event)))
        
        event))))

; Test d'injection manuel d'un Ã©vÃ©nement pour vÃ©rifier que tout fonctionne
(try
  (info "ğŸ§ª Injection d'un Ã©vÃ©nement de test")
  (let [test-event {:host "test-riemann"
                    :service "cpu"
                    :metric 50.0
                    :time (/ (System/currentTimeMillis) 1000)
                    :tags ["test"]}]
    (riemann.core/stream! @riemann.config/core test-event)
    (influx-writer test-event)
    (info "âœ… Ã‰vÃ©nement test injectÃ© avec succÃ¨s"))
  (catch Exception e
    (error "âŒ Erreur lors de l'injection du test:" (.getMessage e))))

(info "ğŸ”„ Configuration Riemann chargÃ©e - En attente d'Ã©vÃ©nements...")